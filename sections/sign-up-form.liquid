{%- liquid
	assign section_heading = section.settings.heading
	assign marker_style = section.settings.marker_style
	assign section_description = section.settings.description
	assign show_phone_number = section.settings.show_phone_number

  assign color_bg = section.settings.color_bg | downcase
  assign color_bg_secondary = section.settings.color_bg_secondary | downcase
	assign color_heading = section.settings.color_heading
	assign color_text = section.settings.color_text
  assign color_links = section.settings.color_links
	assign marker_color = section.settings.marker_color

	assign desktop_spacing_top = section.settings.desktop_spacing_top
  assign desktop_spacing_bottom = section.settings.desktop_spacing_bottom
  assign mobile_spacing_top = section.settings.mobile_spacing_top
  assign mobile_spacing_bottom = section.settings.mobile_spacing_bottom
  assign disable_top_spacing = section.settings.disable_top_spacing
  assign disable_bottom_spacing = section.settings.disable_bottom_spacing

	if section.blocks.size == 0
		assign form_class = 'sign-up-form--has-no-blocks'
	endif

  assign color_body_bg = settings.color_body_bg | downcase

	assign transparent = false
	if color_body_bg == color_bg or color_bg == 'transparent' or color_bg == 'rgba(0,0,0,0)'
  assign transparent = true
	endif
	assign transparent_secondary = false
	if color_bg_secondary == color_bg or color_bg_secondary == 'transparent' or color_bg_secondary == 'rgba(0,0,0,0)'
		assign transparent_secondary = true
	endif
-%}

{{- 'sign-up-form.css' | asset_url | stylesheet_tag -}}

{% style %}
#shopify-section-{{ section.id }} {
  --section-spacing-mobile-top: {{ mobile_spacing_top | default: '15' | append: 'px' }};
  --section-spacing-mobile-bottom: {{ mobile_spacing_bottom | default: '15' | append: 'px' }};
  --section-spacing-desktop-top: {{ desktop_spacing_top | default: '30' | append: 'px' }};
  --section-spacing-desktop-bottom: {{ desktop_spacing_bottom | default: '30' | append: 'px' }};
}
{% endstyle %}


<div id="sign_up" class="sign-up-form sign-up-form--transparent-{{ transparent }} {% if transparent %}section-spacing{% else %}section-spacing-padding{% endif %}{% if disable_top_spacing %} section-spacing--disable-top{% endif %}{% if disable_bottom_spacing %} section-spacing--disable-bottom{% endif %}" style="--color-bg: {{ color_bg }}; --color-heading: {{ color_heading }}; --color-text: {{ color_text }}; --bg-body: {{ color_bg }}; --color-accent: {{ color_links }}; --color-accent-rgb: {{ color_links.rgb | replace: ' ' , ',' }};">
	<div class="row align-center">
    <div class="small-12 medium-8 columns sign-up-form sign-up-form--transparent-{{ transparent_secondary }}"  style="--color-bg: {{ color_bg_secondary }}; --bg-body: {{ color_bg_secondary }};">
      {%- if section_heading -%}
        <div class="sign-up-form--text-title">
          <h3 class="section-header--title">
            {% render 'animated-marker-heading', heading: section_heading, style: marker_style, color: marker_color %}
          </h3>
        </div>
      {%- endif -%}
<!-- =========================================================================
  META + reCAPTCHA
=========================================================================== -->
<meta http-equiv="Content-type" content="text/html; charset=UTF-8">
<script src="https://www.google.com/recaptcha/api.js" async defer></script>

<style>
  /* Hide the two Salesforce fields visually but keep them in the form. */
  .hidden-field {
    position: absolute !important;
    left: -9999px !important;
    width: 1px !important;
    height: 1px !important;
    overflow: hidden !important;
  }
  /* Disabled button style */
  .btn-disabled {
    opacity: 0.55;
    cursor: not-allowed;
  }
  .error {
    color: #b00020;
    font-size: 0.9rem;
    margin: 4px 0 8px 0;
  }
  .field {
    margin-bottom: 10px;
  }
  .field label {
    display: inline-block;
    margin-bottom: 4px;
  }
  .required-star::after {
    content: " *";
    color: #b00020;
  }
</style>

<script>
  // Keep Salesforce’s timestamping logic for captcha fallback
  function timestamp() {
    var response = document.getElementById("g-recaptcha-response");
    if (!response || response.value.trim() === "") {
      var csEl = document.getElementsByName("captcha_settings")[0];
      if (!csEl) return;
      var elems = {};
      try { elems = JSON.parse(csEl.value || "{}"); } catch (e) { elems = {}; }
      elems["ts"] = String(new Date().getTime());
      csEl.value = JSON.stringify(elems);
    }
  }
  setInterval(timestamp, 500);

  // --- reCAPTCHA callbacks ---
  function onRecaptchaSuccess() {
    var submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.classList.remove('btn-disabled');
    }
    var msg = document.getElementById('captchaError');
    if (msg) msg.textContent = '';
  }

  function onRecaptchaExpired() {
    var submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
    }
  }

  function onRecaptchaError() {
    // Treat as not solved
    onRecaptchaExpired();
  }

  // --- Simple validators ---
  function isEmailValid(value) {
    // Reasonable basic email pattern (not overly strict)
    var re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(String(value).trim());
  }

  function isPhoneValid(value) {
    // Require at least 10 digits (US-like). Adjust if you accept intl formats.
    var digits = String(value).replace(/\D/g, "");
    return digits.length >= 10;
  }

  function setError(id, message) {
    var el = document.getElementById(id);
    if (el) el.textContent = message || '';
  }

  function clearAllErrors() {
    setError('companyError', '');
    setError('firstNameError', '');
    setError('lastNameError', '');
    setError('phoneError', '');
    setError('emailError', '');
    setError('captchaError', '');
  }

  document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('webToLeadForm');
    var submitBtn = document.getElementById('submitBtn');

    // Ensure disabled until captcha solved
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.classList.add('btn-disabled');
    }

    // Hide + reference Salesforce fields
    var isProSignup = document.getElementById('00NPa00000Fl7Jx'); // checkbox
    var formType = document.getElementById('00NPa00000Fl7qD');   // select
    var lblPro = document.querySelector('label[for="00NPa00000Fl7Jx"]');
    var lblType = document.querySelector('label[for="00NPa00000Fl7qD"]');
    if (lblPro) lblPro.classList.add('hidden-field');
    if (isProSignup) isProSignup.classList.add('hidden-field');
    if (lblType) lblType.classList.add('hidden-field');
    if (formType) formType.classList.add('hidden-field');

    // Live validations on blur (optional UX enhancement)
    var company = document.getElementById('company');
    var firstName = document.getElementById('first_name');
    var lastName = document.getElementById('last_name');
    var phone = document.getElementById('phone');
    var email = document.getElementById('email');

    company.addEventListener('blur', function(){ setError('companyError', company.value.trim() ? '' : 'Company is required.'); });
    firstName.addEventListener('blur', function(){ setError('firstNameError', firstName.value.trim() ? '' : 'First Name is required.'); });
    lastName.addEventListener('blur', function(){ setError('lastNameError', lastName.value.trim() ? '' : 'Last Name is required.'); });
    phone.addEventListener('blur', function(){ setError('phoneError', isPhoneValid(phone.value) ? '' : 'Please enter a valid phone number (10+ digits).'); });
    email.addEventListener('blur', function(){ setError('emailError', isEmailValid(email.value) ? '' : 'Please enter a valid email address.'); });

    form.addEventListener('submit', function (e) {
      clearAllErrors();

      // Enforce reCAPTCHA
      var response = document.getElementById('g-recaptcha-response');
      var captchaOk = response && response.value && response.value.trim().length > 0;

      // Validate required fields
      var valid = true;

      if (!company.value.trim()) { setError('companyError', 'Company is required.'); valid = false; }
      if (!firstName.value.trim()) { setError('firstNameError', 'First Name is required.'); valid = false; }
      if (!lastName.value.trim()) { setError('lastNameError', 'Last Name is required.'); valid = false; }
      if (!isPhoneValid(phone.value)) { setError('phoneError', 'Please enter a valid phone number (10+ digits).'); valid = false; }
      if (!isEmailValid(email.value)) { setError('emailError', 'Please enter a valid email address.'); valid = false; }

      if (!captchaOk) {
        setError('captchaError', 'Please complete the reCAPTCHA to proceed.');
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.classList.add('btn-disabled');
        }
        valid = false;
      }

      if (!valid) {
        e.preventDefault();
        return false;
      }

      // Auto-set hidden Salesforce fields immediately before submit
      if (isProSignup) {
        isProSignup.checked = true;  // value="1" will be sent when checked
        isProSignup.value = '1';
      }
      if (formType) {
        formType.value = 'Pro Signup'; // must match Salesforce picklist API value
      }

      return true;
    });
  });
</script>

<!-- =========================================================================
  SALESFORCE WEB-TO-LEAD FORM
=========================================================================== -->
<form id="webToLeadForm" action="https://webto.salesforce.com/servlet/servlet.WebToLead?encoding=UTF-8&amp;orgId=00D8c000002heT1" method="POST">
  <input type="hidden" name="captcha_settings" value='{"keyname":"ThermoSoft","fallback":"true","orgId":"00D8c000002heT1","ts":""}'>
  <input type="hidden" name="oid" value="00D8c000002heT1">
  <!-- ✅ Updated redirect to your thank-you page -->
  <input type="hidden" name="retURL" value="https://www.thermosoft.com/pages/thank-you">

  <!-- Debug (optional)
  <input type="hidden" name="debug" value="1">
  <input type="hidden" name="debugEmail" value="socmktg@thermosoft.com">
  -->
<div class="row no-padding">
  <div class="small-12 medium-12 columns">
    <div class="field">
      <input class="full" id="company" maxlength="40" name="company" size="20" type="text" required>
      <label class="required-star" for="company">Company</label>
      <div id="companyError" class="error" aria-live="polite"></div>
    </div>
   </div>

   <div class="small-12 medium-12 columns">
    <div class="field">
      <input class="full" id="first_name" maxlength="40" name="first_name" size="20" type="text" required>
      <label class="required-star" for="first_name">First Name</label>
      <div id="firstNameError" class="error" aria-live="polite"></div>
    </div>
   </div>

   <div class="small-12 medium-12 columns">
    <div class="field">
      <input class="full" id="last_name" maxlength="80" name="last_name" size="20" type="text" required>
      <label class="required-star" for="last_name">Last Name</label>
      <div id="lastNameError" class="error" aria-live="polite"></div>
    </div>
  </div>

  <div class="small-12 medium-12 columns">
    <div class="field">
      <input class="full" id="phone" maxlength="40" name="phone" size="20" type="tel" required>
      <label class="required-star" for="phone">Phone</label>
      <div id="phoneError" class="error" aria-live="polite"></div>
    </div>
  </div>

  <div class="small-12 medium-12 columns">
    <div class="field">
      <input class="full" id="email" maxlength="80" name="email" size="20" type="email" required>
      <label class="required-star" for="email">Email</label>
      <div id="emailError" class="error" aria-live="polite"></div>
    </div>
  </div>

    <!-- Hidden: Is Pro Signup (checkbox) -->
    <div class="small-12 medium-12 columns">
      <div class="field">
        <input id="00NPa00000Fl7Jx" name="00NPa00000Fl7Jx" type="checkbox" value="1" class="hidden-field full">
        <label for="00NPa00000Fl7Jx" class="hidden-field">Is Pro Signup</label>
      </div>
    </div>

    <!-- Hidden: Form Submission Type (select) -->
    <div class="small-12 medium-12 columns">
      <div class="field">
        <select id="00NPa00000Fl7qD" name="00NPa00000Fl7qD" title="Form Submission Type" class="hidden-field full">
          <option value="">--None--</option>
          <option value="Pro Signup">Pro Signup</option>
        </select>
      <label for="00NPa00000Fl7qD" class="hidden-field">Form Submission Type</label>
    </div>
    </div>

    <!-- Google reCAPTCHA: enable submit only after success -->
    <div class="small-12 medium-12 columns">
      <div class="field">
    <div class="g-recaptcha"
        data-sitekey="6LdEvmIsAAAAAHX0hXeRCKK6_G2WqBwAy5agVzSO"
        data-callback="onRecaptchaSuccess"
        data-expired-callback="onRecaptchaExpired"
        data-error-callback="onRecaptchaError">
    </div>
    <div id="captchaError" class="error" aria-live="polite"></div>
    </div>
    </div>

    <div class="small-12 medium-12 columns">
      <div class="field">
    <input id="submitBtn" type="submit" name="submit" value="Submit" class="btn full">
    </div>
    </div>
  </div>
</form>
			{% comment %} {% form 'contact', class: form_class %}
				{% if form.posted_successfully? %}
				<div class="form-notification success">
					{% render 'svg-icons' with 'thb-success' %} {{ 'sections.contact.form.post_success' | t }}
				</div>
				{%- elsif form.errors %}
				<div class="form-notification error">
					{% render 'svg-icons' with 'thb-error' %} {{ 'sections.contact.form.error_heading' | t }} {{ form.errors | default_errors }}
				</div>
				{% endif %}
				<div class="row no-padding">
					<div class="small-12 medium-12 columns">
						<div class="field">
							<input type="text" id="ContactFormCompany" name="contact[company]" class="full" placeholder="{{ 'sections.contact.form.company' | t | escape }}" required>
							<label for="ContactFormName">{{ 'sections.contact.form.company' | t }}*</label>
						</div>
					</div>
					<div class="small-12 medium-12 columns">
						<div class="field">
							<input type="text" id="ContactFormName" name="contact[name]" class="full" placeholder="{{ 'sections.contact.form.name' | t | escape }}" required>
							<label for="ContactFormName">{{ 'sections.contact.form.name' | t }}*</label>
						</div>
					</div>
					{%- if show_phone_number -%}
            <div class="small-12 medium-12 columns">
              <div class="field">
                <input type="tel" id="ContactFormPhone" name="contact[phone]" class="full" placeholder="{{ 'sections.contact.form.phone' | t | escape }}" required>
								<label for="ContactFormPhone">{{ 'sections.contact.form.phone' | t }}*</label>
              </div>
            </div>
					{%- endif -%}
          <div class="small-12 medium-12 columns">
            <div class="field">
              <input type="email" id="ContactFormEmail" name="contact[email]" class="full" placeholder="{{ 'sections.contact.form.email' | t | escape }}" pattern="^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,10})(\]?)$" required>
							<label for="ContactFormEmail">{{ 'sections.contact.form.email' | t }}*</label>
						</div>
					</div>
          <div class="small-12 medium-12 columns">
            <div class="field">
              <input type="text" id="ContactFormName" name="contact[zip code]" class="full" placeholder="{{ 'sections.contact.form.zip_code' | t | escape }}">
              <label for="ContactFormName">{{ 'sections.contact.form.zip_code' | t }}</label>
            </div>
          </div>
					{%- for block in section.blocks -%}
						{%- liquid
							assign field_title = block.settings.title
							if field_title == blank
								capture field_title
									echo 'Custom field ' | append: field_index
								endcapture
							endif
						-%}
						{%- case block.type -%}
							{%- when 'text_field' -%}
							<div class="small-12 medium-12 columns">
								<div class="field">
								{%- if block.settings.use_long_text -%}
									<textarea id="{{ block.id }}" name="contact[{{ field_title | escape }}]" cols="30" rows="10" class="full" aria-label="{{ block.settings.title | escape }}" placeholder="{{ block.settings.title | escape }}" {% if block.settings.is_required %}required{% endif %}></textarea>
									<label for="{{ block.id }}">{{ block.settings.title | escape }}</label>
								{%- else -%}
									<input id="{{ block.id }}" type="text" class="full" name="contact[{{ field_title | escape }}]" aria-label="{{ block.settings.title | escape }}" placeholder="{{ block.settings.title | escape }}" {% if block.settings.is_required %}required{% endif %}>
									<label for="{{ block.id }}">{{ block.settings.title | escape }}</label>
								{%- endif -%}
								</div>
							</div>
							{%- assign field_index = field_index | plus: 1 -%}
						{%- when 'radio_field' -%}
              {%- liquid
                assign values = block.settings.values | split: ','
								if values == empty
									continue
								endif
                
              -%}
              <fieldset class="small-12 columns" {{ block.shopify_attributes }}>
                <div class="form__label" for="{{ block.id }}">{{ block.settings.title | escape }}</div>
                {% for value in values %}
                  {%- assign trim_value = value | strip -%}
                  <label class="label">
                    <input type="radio" name="contact[{{ field_title | escape }}]" value="{{ trim_value | escape }}">
                    <span class="label__text-beside-input">{{ trim_value | escape }}</span>
                  </label>
                {% endfor %}
              </fieldset>
						{%- when 'dropdown_field' -%}
							{%- liquid
								assign values = block.settings.values | split: ','
								if values == empty
									continue
								endif
							-%}
							<div class="small-12 medium-12 columns">
								<div class="field select">
									<select class="full" name="contact[{{ field_title | escape }}]" title="{{ block.settings.title | escape }}" required>
										<option value="" disabled selected>{{ block.settings.title | escape }}</option>
										{%- for value in values -%}
											{%- assign trim_value = value | strip -%}
											<option value="{{ trim_value | escape }}">{{ trim_value | escape }}</option>
										{%- endfor -%}
									</select>
									{% comment %} <label for="{{ block.id }}">{{ block.settings.title | escape }}</label> {% endcomment %}
								</div>
							</div>
							{%- assign field_index = field_index | plus: 1 -%}
						{%- endcase -%}
					{%- endfor -%}			
          <div class="small-12 medium-12 columns">
						<button type="submit" class="button full"><span>{{ 'sections.contact.form.send' | t }}</span></button>
					</div>
          {%- if section_description != blank -%}
            <div class="small-12 medium-12 columns sign-up-form--text-description">
              <div class="section-header--description rte">
                {{ section_description }}
              </div>
            </div>
          {%- endif -%}
				</div>
			{% endform %} {% endcomment %}
		</div>
		
	</div>
</div>

{% schema %}
{
  "name": "Sign-up form",
  "class": "section-sign-up-form",
  "settings": [
		{
			"type": "text",
			"id": "heading",
			"label": "Heading",
			"default": "Sign-up form",
			"info": "Wrap your text between | to add animated markers. For example: Animated |marker| will underline marker text."
		},
		{
			"type": "select",
			"id": "marker_style",
			"options": [
				{
					"value": "style1",
					"label": "Basic"
				},
				{
					"value": "style2",
					"label": "Double"
				},
				{
					"value": "style3",
					"label": "Squiggle"
				},
				{
					"value": "style4",
					"label": "Zigzag"
				}
			],
			"default": "style1",
			"label": "Marker"
		},
		{
			"type": "richtext",
			"id": "description",
			"label": "Description",
			"default": "<p>Add a short description for this section</p>"
		},
		{
			"type": "checkbox",
			"id": "show_phone_number",
			"default": true,
			"label": "Show phone number"
		},
		{
			"type": "header",
			"content": "Colors"
		},
    {
      "type": "color",
      "id": "color_bg",
      "label": "Background",
      "default": "transparent"
    },
    {
      "type": "color",
      "id": "color_bg_secondary",
      "label": "Background secondary",
      "default": "#FFFFFF"
    },
    {
      "type": "color_background",
      "id": "color_heading",
      "label": "Heading",
      "default": "#1a1c1d"
    },
    {
      "type": "color",
      "id": "color_text",
      "label": "Text",
      "default": "#2c2d2e"
    },
    {
      "type": "color",
      "id": "color_links",
      "label": "Links",
      "default": "#2c2d2e"
    },
		{
			"type": "color",
			"id": "marker_color",
			"label": "Marker",
			"default": "#FD6262"
		},
		{
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "checkbox",
      "id": "disable_top_spacing",
      "default": false,
      "label": "Remove top spacing"
    },
    {
      "type": "checkbox",
      "id": "disable_bottom_spacing",
      "default": false,
      "label": "Remove bottom spacing"
    },
    {
      "type": "header",
      "content": "Desktop spacing"
    },
    {
      "type": "range",
      "id": "desktop_spacing_top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Desktop spacing top",
      "default": 30,
      "info": "Changes the section top spacing in desktop screens."
    },
    {
      "type": "range",
      "id": "desktop_spacing_bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "label": "Desktop spacing bottom",
      "default": 30,
      "info": "Changes the section bottom spacing in desktop screens."
    },
    {
      "type": "header",
      "content": "Mobile spacing"
    },
    {
      "type": "range",
      "id": "mobile_spacing_top",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Mobile spacing top",
      "default": 15,
      "info": "Changes the section top spacing in mobile screens."
    },
    {
      "type": "range",
      "id": "mobile_spacing_bottom",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "label": "Mobile spacing bottom",
      "default": 15,
      "info": "Changes the section bottom spacing in mobile screens."
    }
  ],
	"blocks": [
    {
      "type": "text_field",
      "name": "Text field",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Name",
          "default": "Custom field"
        },
        {
          "type": "checkbox",
          "id": "use_long_text",
          "label": "Use long text",
          "default": false
        },
        {
          "type": "checkbox",
          "id": "is_required",
          "label": "Field is required",
          "default": false
        }
      ]
    },
    {
      "type": "dropdown_field",
      "name": "Dropdown field",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Name",
          "default": "Custom field"
        },
        {
          "type": "text",
          "id": "values",
          "label": "Values",
          "info": "Separate each value by a comma.",
          "default": "value 1, value 2, value 3"
        }
      ]
    },
    {
      "type": "radio_field",
      "name": "Radio field",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Name",
          "default": "Custom field"
        },
        {
          "type": "text",
          "id": "values",
          "label": "Values",
          "info": "Separate each value by a comma.",
          "default": "value 1, value 2, value 3"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Sign-up form",
      "blocks": [
        
      ]
    }
  ],
	"enabled_on": {
		"templates": ["*"],
		"groups": [
			"header", "footer"
		]
	}
}
{% endschema %}
