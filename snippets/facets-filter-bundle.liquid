{% comment %}
    Renders facets (filtering and sorting)
    Accepts:
    - results: {Object} Collection or Search object
    - enable_filtering: {Boolean} Show filtering when true
    - enable_sorting: {Boolean} Show sorting when true
    - collapse_on_larger_devices: {Boolean} Collapse filtering/sorting into menu on larger devices when true
    Usage:
    {% render 'facets', results: collection, enable_filtering: true, enable_sorting: true, collapse_on_larger_devices: false %}
{% endcomment %}

{%- if enable_filtering -%}
	{%- unless results.products.size == 0 -%}
		<facet-filters-form class="facets-desktop-container facets">
			<sticky-scroller>
				<form id="FacetFiltersForm" class="facets__form sticky-scroller--element">
					{%- if results.terms -%}
						<input type="hidden" name="q" value="{{ results.terms | escape }}">
						<input name="options[prefix]" type="hidden" value="last">
					{%- endif -%}
					{% if results.current_vendor or results.current_type %}
						<input type="hidden" name="q" value="{{ results.current_vendor }}{{ results.current_type }}">
					{% endif %}
					<div class="facets__wrapper">
						{%- for filter in results.filters -%}
              {% assign filter_name = collection.metafields.custom.select_filters.value %}
              {% for filter_label in filter_name %}
              {%- if filter.label contains filter_label  -%}
                {%- liquid
                    assign label = filter.label | downcase | replace: ' ', '-' | escape
                    assign slug = filter.label | downcase | escape

                    assign is_open = true 
                    if filters_collapsed
                      assign is_open = false
                      if filter.active_values.size > 0
                        assign is_open = true
                      endif
                    endif

                    assign box_filter = false
                    assign box_filter_list_array = box_filter_list | newline_to_br | split: '<br />'
                    assign box_filter_key_array = ''
                    assign box_filter_val_array = ''

                    for box_filter in box_filter_list_array
                      assign key = box_filter | split: ':' | first | rstrip
                      assign value = box_filter | split: ':' | last | lstrip
                      assign box_filter_key_array = box_filter_key_array | append: ',' | append: key
                      assign box_filter_val_array = box_filter_val_array | append: ',' | append: value
                    endfor

                    assign box_filter_key_array = box_filter_key_array | remove_first: ',' | strip_newlines | split: ','
                    assign box_filter_val_array = box_filter_val_array | remove_first: ',' | split: ','

                    for box_filter_key in box_filter_key_array
                      if box_filter_key == filter.label
                        assign box_filter = true
                        assign box_filter_column = box_filter_val_array[forloop.index0]
                      endif
                    endfor
                  -%}
                {% case filter.type %}
                  {% when 'boolean' or 'list' %}
                  <collapsible-row data-index="{{ forloop.index }}">
                    <div class="thb-filter js-filter" {%- if is_open %} open{%- endif -%}>
                      <div class="thb-filter-title">{{ filter.label | escape }}
                         {% comment %} {% if collection.metafields.custom.how_to_select_the_right_size %}
                          <modal-opener class="" data-modal="#ProductPopup-free-size">
                            <button class="contact-member-button" type="button" aria-haspopup="dialog">
                              <div class="body-extra-small">How to select the right size</div>
                              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14" fill="none">
                                <path fill-rule="evenodd" clip-rule="evenodd" d="M6.66666 0C10.3485 0 13.3333 2.98475 13.3333 6.66666C13.3333 10.3485 10.3486 13.3333 6.66666 13.3333C2.98478 13.3333 0 10.3486 0 6.66666C0 2.98475 2.98478 0 6.66666 0ZM6.66666 8.83334C6.20638 8.83334 5.83328 9.20641 5.83328 9.66666C5.83328 10.1269 6.20641 10.5 6.66663 10.5C7.12684 10.5 7.49997 10.1269 7.49997 9.66666C7.49997 9.20641 7.12684 8.83334 6.66663 8.83334M6.55538 2.91672C5.90647 2.91672 5.36106 3.0935 4.91981 3.44609C4.39694 3.86847 4.13572 4.49222 4.13572 5.31791H5.55328V5.30841C5.55328 4.99337 5.61963 4.73497 5.75203 4.53341C5.93469 4.26247 6.231 4.12684 6.64062 4.12684C6.89272 4.12684 7.10728 4.19303 7.28344 4.32516C7.50388 4.50822 7.61447 4.78531 7.61447 5.15716C7.61447 5.39037 7.55747 5.59822 7.44416 5.78109C7.34963 5.94491 7.19841 6.10547 6.99016 6.26313C6.54909 6.56559 6.26228 6.865 6.13016 7.16134C6.01669 7.40709 5.95969 7.79781 5.95969 8.33334H7.29297C7.29297 7.98034 7.33988 7.71584 7.43484 7.53928C7.51034 7.39434 7.66806 7.24006 7.90756 7.07609C8.32366 6.76719 8.61959 6.48034 8.79619 6.21566C9.01034 5.90066 9.11769 5.53188 9.11769 5.1095C9.11769 4.23419 8.76169 3.61331 8.04909 3.24763C7.62081 3.02709 7.12291 2.91666 6.55541 2.91666" fill="#900000"/>
                              </svg>
                            </button>
                          </modal-opener> 
                        {% endif %} {% endcomment %}
                      </div>
                      <div class="thb-filter-content collapsible__content">
                        <scroll-shadow>
                          {%- liquid
                            if slug contains 'color' or slug contains 'colour' or slug contains 'couleur' or slug contains 'farbe'
                              if filter_color_swatches
                                assign slug = 'color'
                              else
                                assign slug = ''
                              endif
                            endif

                            # Additional swatch variant options set inside theme settings
                            assign color_swatches_variant_option = settings.color_swatches_variant_option | downcase | split: ', '

                            if color_swatches_variant_option contains slug
                              assign slug = 'color'
                            endif

                            if filter.presentation == 'swatch'
                              assign slug = 'color'
                            endif
                          -%}
                          <ul class="{{ filter.type | escape }}-{{ slug }}{% if box_filter %} list--boxed{% endif %}"{% if box_filter %} style="--max-boxes: {{ box_filter_column }}"{% endif %}>
                            {%- liquid
                            assign custom_colors = settings.color_swatches | newline_to_br | split: '<br />'
                            assign key_array = ''
                            assign val_array = ''

                            for color in custom_colors
                              assign key = color | split: ':' | first | rstrip
                              assign value = color | split: ':' | last | lstrip
                              assign key_array = key_array | append: ',' | append: key
                              assign val_array = val_array | append: ',' | append: value
                            endfor

                            assign key_array = key_array | remove_first: ',' | strip_newlines | downcase | split: ','
                            assign val_array = val_array | remove_first: ',' | split: ','

                            assign sorted_values = filter.values
                            # Keep the selected values grouped together when operator is AND
                            if filter.operator == 'AND'
                              assign active_filter_values = filter.values | where: 'active', true
                              assign inactive_filter_values = filter.values | where: 'active', false
                              assign sorted_values = active_filter_values | concat: inactive_filter_values
                            endif
                            -%}
                            {%- for value in sorted_values -%}
                              <li>
                                <input type="radio"
                                  name="{{ value.param_name }}"
                                  value="{{ value.value }}"
                                  id="Filter-{{ label }}-{{ forloop.index }}"
                                  {% if value.active %}checked{% endif %}
                                  {% if value.count == 0 and value.active == false %}disabled{% endif %}
                                >
                                {%- if filter.presentation == 'swatch' -%}
                                  {%- liquid
                                    assign bg_value = empty
                                    assign color_value = value.swatch.color

                                    if value.swatch.image
                                      assign bg_value = value.swatch.image | image_url: width: 40
                                    endif

                                  -%}
                                  <label
                                    for="Filter-{{ label }}-{{ forloop.index }}"
                                    class="facet-checkbox {% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}"
                                    style="--bg-color: {{ color_value }}; {%- unless bg_value == empty -%}--option-color-image: url('{{ bg_value }}'){%- endunless -%};"
                                    data-tooltip="{{ value.label | escape }} ({{ value.count }})"
                                  >
                                    <span class="filter-color"></span>
                                    <span class="filter-name">{{ value.label | escape }}</span>  {% if show_counts -%}<sup class="count">{{ value.count }}</sup>{%- endif -%}
                                  </label>
                                {%- else -%}
                                  {%- liquid
                                    assign color_value = value.value | downcase | escape

                                    for custom_color in key_array
                                      if custom_color == color_value
                                        assign color_value = val_array[forloop.index0]
                                      endif
                                    endfor

                                    assign bg_value = false
                                    if color_value contains '.'
                                      assign bg_value = color_value | file_url
                                      assign color_value = 'var(--bg-body)'
                                    endif
                                  -%}
                                  <label for="Filter-{{ label }}-{{ forloop.index }}" class="facet-checkbox{% if value.count == 0 and value.active == false %} facet-checkbox--disabled{% endif %}" style="--bg-color: {{ color_value | downcase | escape }};{%- if bg_value -%} --option-color-image: url('{{ bg_value | escape }}');{%- endif -%}" data-tooltip="{{ value.label | escape }} ({{ value.count }})">
                                    <span class="filter-color"></span>
                                    <span class="filter-name">{{- value.label | escape }}</span> {% if show_counts %}<span class="count">({{ value.count }})</span>{% endif %}
                                  </label>
                                  {%- endif -%}
                              </li>
                            {%- endfor -%}
                          </ul>
                        </scroll-shadow>
                      </div>
                    </div>
                  </collapsible-row>
                {% endcase %}
              {%- endif -%}
						{%- endfor -%}
						{%- endfor -%}
					</div>
				</form>
			</sticky-scroller>
		</facet-filters-form>
		<script src="{{ 'sticky-scroller.js' | asset_url }}" defer="defer"></script>
	{%- endunless -%}
{%- endif -%}
{% if collection.metafields.custom.how_to_select_the_right_size %}
  <modal-dialog id="ProductPopup-free-size" class="product-popup-modal">
        <div role="dialog" aria-label="{{ block.settings.title }}" aria-modal="true" class="product-popup-modal__content" tabindex="-1">
          <button id="ModalClose-desktop-{{ block.id }}" type="button" class="product-popup-modal__toggle" aria-label="{{ 'accessibility.close' | t }}">{% render 'svg-icons' with 'close' %}</button>
          <scroll-shadow>
            <div class="product-popup-modal__content-info">										
              <div class="talk-us">
                <div class="talk-contact-full">
                  <div class="talk-contact-form" id="talkPopup">
                    <div class="align-center">
                      <div class="small-12 contact-form--form-column">
                        <div class="free-size-content">
                          <div class="free-size-img">
                            {% comment %} {{ collection.metafields.custom.how_to_select_the_right_size.value.image }}-- {% endcomment %}
                            {% comment %} {{ collection.metafields.custom.how_to_select_the_right_size.value.content }}-- {% endcomment %}
                            <img src="{{ collection.metafields.custom.how_to_select_the_right_size.value.image | img_url: 'master' }}">
                          </div>
                          <div class="free-size-description">
                            {% comment %} {{ section.settings.free-size-content }} {% endcomment %}
                            {{ collection.metafields.custom.how_to_select_the_right_size.value.content | metafield_tag }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </scroll-shadow>
        </div>
      </modal-dialog>
    {% endif %}
    <script src="{{ 'modal-dialog.js' | asset_url }}" defer="defer"></script>